
{%- assign current_variant = product.variants | where: 'available', true | first | default: product.variants.first -%}

{% assign featured_image = current_variant.featured_image | default: product.featured_image %}
{% assign product_form_id = 'product-form-' | append: section_id | append: '-' | append: product.id %}

{% assign show_vendor = show_vendor | default: false %}
{% assign show_price = show_price | default: false %}
{% assign show_tags = show_tags | default: false %}
{% assign show_certificate_badge = show_certificate_badge | default: false %}
{% assign certificate_text = certificate_text | default: 'Gift Certificate' %}
{% assign show_add_to_cart = show_add_to_cart | default: true %}
{% assign variant_label = variant_label | default: 'Option' %}
{% assign quantity_label = quantity_label | default: 'Quantity' %}
{% assign add_to_cart_text = add_to_cart_text | default: 'Add to Cart' %}
{% assign view_details_text = view_details_text | default: 'View Details' %}

<div class="product-card bg-white rounded-2xl overflow-hidden shadow hover:shadow-xl transition-all duration-300 hover:-translate-y-1" 
     data-product-id="{{ product.id }}"
     data-product-handle="{{ product.handle }}">
  
  <!-- Certificate Badge -->
  {% if show_certificate_badge %}
    <div class="absolute top-4 left-4 z-20 px-3 py-1 rounded-full bg-gradient-to-r from-red-500 to-red-600 text-white text-sm font-bold animate-pulse">
      {{ certificate_text }}
    </div>
  {% endif %}
  
  <!-- Price Badge -->
  {% if show_price %}
    <div class="absolute top-4 right-4 z-20 px-3 py-2 rounded-lg bg-gradient-to-r from-yellow-400 to-yellow-500 text-white font-bold">
      <span class="product-price-{{ product.id }} text-lg">{{ current_variant.price | money }}</span>
      {% if current_variant.compare_at_price > current_variant.price %}
        <br><span class="line-through text-sm opacity-75">{{ current_variant.compare_at_price | money }}</span>
      {% endif %}
    </div>
  {% endif %}
  
  <!-- Sale Badge -->
  {% if current_variant.compare_at_price > current_variant.price %}
    <div class="absolute top-4 left-1/2 transform -translate-x-1/2 z-20 bg-red-600 text-white px-2 py-1 rounded text-xs font-bold">
      SAVE {{ current_variant.compare_at_price | minus: current_variant.price | money }}
    </div>
  {% endif %}
  
  <!-- Product Image -->
  <a href="{{ product.url }}" class="block relative h-48 bg-gradient-to-br from-gray-100 to-gray-200 overflow-hidden">
    {% if featured_image %}
      <img src="{{ featured_image | image_url: width: 400 }}" class="bg-[#ffe4c4] w-full h-full object-contain transition-transform duration-300 hover:scale-105" alt="{{ product.title | escape }}" loading="lazy" sizes="(min-width: 1024px) 400px, (min-width: 768px) 350px, 300px" width="{{ featured_image.width }}" height="{{ featured_image.height }}">
     
    {% else %}
      <div class="w-full h-full flex items-center justify-center bg-gray-200">
        <svg class="w-16 h-16 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
        </svg>
      </div>
    {% endif %}
    
    <!-- Out of Stock Overlay -->
    {%- unless product.available -%}
      <div class="absolute inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center">
        <span class="bg-red-600 text-white px-4 py-2 rounded-lg font-bold">Out of Stock</span>
      </div>
    {% endunless %}
  </a>
  
  <!-- Product Info -->
  <div class="p-6">
    {% if show_vendor and product.vendor != blank %}
      <p class="text-sm text-gray-500 mb-1">{{ product.vendor }}</p>
    {% endif %}
    
    <a href="{{ product.url }}" class="block">
      <h4 class="text-xl font-bold text-gray-900 mb-2 hover:text-red-600 transition-colors duration-200">
        {{ product.title | escape }}
      </h4>
    </a>
    
    <!-- Product Tags -->
    {% if show_tags and product.tags.size > 0 %}
      <div class="flex flex-wrap gap-2 mb-4">
        {% for tag in product.tags limit: 3 %}
          <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
            {{ tag }}
          </span>
        {% endfor %}
        {% if product.tags.size > 3 %}
          <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">
            +{{ product.tags.size | minus: 3 }} more
          </span>
        {% endif %}
      </div>
    {% endif %}
    
    <!-- Add to Cart Form -->
    {% if show_add_to_cart %}
      <form action="{{ routes.cart_add_url }}" method="post" enctype="multipart/form-data" 
            class="add-to-cart-form-{{ product.id }} space-y-4" 
            id="{{ product_form_id }}">
        
        <!-- Variant Selection -->
        {% if product.variants.size > 1 %}
          <div class="variant-selector-wrapper">
            <label for="variant-{{ product.id }}" class="block text-sm font-medium text-gray-700 mb-2">
              {{ variant_label }}:
            </label>
            <select id="variant-{{ product.id }}" 
                    name="id" 
                    class="variant-selector w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-red-500 focus:border-transparent bg-white" 
                    data-product-id="{{ product.id }}"
                    required>
              {% for variant in product.variants %}
                <option value="{{ variant.id }}" 
                        data-price="{{ variant.price }}"
                        data-compare-price="{{ variant.compare_at_price }}"
                        data-available="{{ variant.available }}"
                        data-inventory="{{ variant.inventory_quantity }}"
                        {% if variant == current_variant %}selected{% endif %}
                        {% unless variant.available %}disabled{% endunless %}>
                 Up to {{ variant.title }}
                </option>
              {% endfor %}
            </select>
          </div>
        {% else %}
          <input type="hidden" name="id" value="{{ current_variant.id }}">
        {% endif %}
        
        <!-- Quantity Control -->
        <div class="quantity-wrapper">
          <label for="quantity-{{ product.id }}" class="block text-sm font-medium text-gray-700 mb-2">
            {{ quantity_label }}:
          </label>
          <div class="flex items-center border border-gray-300 rounded-lg overflow-hidden">
            <button type="button" 
                    class="quantity-decrease p-3 bg-gray-100 hover:bg-gray-200 transition-colors duration-200 text-gray-600 hover:text-gray-800"
                    data-product-id="{{ product.id }}">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
              </svg>
            </button>
            <input type="number" 
                   id="quantity-{{ product.id }}" 
                   name="quantity" 
                   value="1" 
                   min="1" 
                   class="quantity-input flex-1 p-3 text-center border-0 focus:ring-0 focus:outline-none"
                   data-product-id="{{ product.id }}">
            <button type="button" 
                    class="quantity-increase p-3 bg-gray-100 hover:bg-gray-200 transition-colors duration-200 text-gray-600 hover:text-gray-800"
                    data-product-id="{{ product.id }}">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
              </svg>
            </button>
          </div>
        </div>
        
        <!-- Add to Cart Button -->
        <button type="submit" 
                class="add-to-cart-btn w-full flex gap-1 justify-center items-center py-3 px-6 bg-brandPrimary hover:from-red-600 hover:to-red-700 text-white font-bold rounded-lg transition-all duration-200 transform hover:-translate-y-1 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:hover:from-red-500 disabled:hover:to-red-600"
                data-product-id="{{ product.id }}"
                {%- unless product.available -%}disabled{% endunless %}>
          {% if product.available %}
            {% render 'cart-icon' %} {{ add_to_cart_text }}
          {% else %}
            ‚ùå Sold Out
          {% endif %}
        </button>
        
        <!-- Product Link -->
        <a href="{{ product.url }}" 
           class="block w-full py-2 px-6 text-center border-2 border-red-500 text-red-500 font-medium rounded-lg hover:bg-red-50 transition-all duration-200">
          {{ view_details_text }}
        </a>
      </form>
    {% else %}
      <!-- Just view details link if cart is disabled -->
      <a href="{{ product.url }}" 
         class="block w-full py-3 px-6 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold text-center rounded-lg transition-all duration-200 transform hover:-translate-y-1 hover:shadow-lg">
        {{ view_details_text }}
      </a>
    {% endif %}
  </div>
</div>